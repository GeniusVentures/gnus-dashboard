name: CI/CD Deploy Genius Dashboard Backend/Frontend

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'README.md'
      - '.github/**'
  workflow_dispatch:

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run security audit
        run: |
          npm audit --audit-level high
          
  deploy:
    runs-on: ubuntu-latest
    needs: security-scan
    environment: ${{ github.ref_name }}
    steps:
      - name: Deploy to AWS/EC2
        if: (github.ref_name == 'main' || github.ref_name == 'develop')
        run: |
          # Create temporary SSH key file with proper permissions
          echo "${{ secrets.DEPLOY_ACTION_SSH_PRIVATE_KEY }}" > /tmp/deploy_key
          chmod 600 /tmp/deploy_key
          
          # Verify SSH host key
          ssh-keyscan -H ${{ secrets.DEPLOY_HOSTNAME }} >> ~/.ssh/known_hosts
          
          BRANCH="${GITHUB_REF#refs/heads/}"
          APP_DIR="gnus-dashboard"
          
          ssh -i /tmp/deploy_key deploy@${{ secrets.DEPLOY_HOSTNAME }} <<-ENDSSH
            #!/usr/bin/env bash
            set -e
            
            # Backup current deployment
            if [ -d "gnus-dashboard" ]; then
              cp -r gnus-dashboard gnus-dashboard-backup-\$(date +%Y%m%d-%H%M%S)
            fi
            
            if [ ! -d "gnus-dashboard" ]; then
              git clone git@gnus-dashboard.github.com:GeniusVentures/gnus-dashboard.git
            fi
            
            cd gnus-dashboard
            echo "Branch found is $BRANCH"
            git checkout $BRANCH
            git fetch --all
            git reset --hard origin/$BRANCH
            git pull origin $BRANCH
            
            # Install dependencies and build
            yarn install --frozen-lockfile
            yarn run build $BUILD_OPTIONS
            
            # Health check before restart
            if pm2 describe gnus-dashboard > /dev/null 2>&1; then
              pm2 restart gnus-dashboard --wait-ready
            else
              pm2 start ecosystem.config.js
            fi
            
            # Verify deployment
            sleep 10
            curl -f http://localhost:3000/api/health || exit 1
          ENDSSH
          
          # Clean up SSH key
          rm -f /tmp/deploy_key
